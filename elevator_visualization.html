<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁîµÊ¢ØÁ≥ªÁªüÂÆûÊó∂ÁõëÊéß</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-label {
            color: #666;
            font-size: 14px;
        }

        .status-value {
            color: #333;
            font-weight: bold;
            font-size: 16px;
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }

        .elevator-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .elevator-grid {
            display: flex;
            gap: 30px;
            justify-content: center;
            margin-top: 20px;
        }

        .elevator-shaft {
            position: relative;
            width: 120px;
        }

        .elevator-label {
            text-align: center;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .shaft-container {
            position: relative;
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
        }

        .floor-line {
            height: 60px;
            border-bottom: 1px dashed #cbd5e0;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
        }

        .floor-line:last-child {
            border-bottom: none;
        }

        .floor-number {
            font-size: 12px;
            color: #718096;
            font-weight: 500;
            width: 25px;
        }

        .elevator-car {
            position: absolute;
            width: 80px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transition: top 0.3s ease-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 11px;
            padding: 5px;
            z-index: 10;
            left: 30px;
        }

        .elevator-car.moving-up {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .elevator-car.moving-down {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        }

        .elevator-car.stopped {
            background: linear-gradient(135deg, #718096 0%, #4a5568 100%);
        }

        .elevator-passengers {
            font-weight: bold;
            margin-top: 3px;
        }

        .elevator-target {
            font-size: 10px;
            opacity: 0.9;
        }

        .direction-indicator {
            position: absolute;
            top: -15px;
            right: 5px;
            font-size: 18px;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .info-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .panel-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #f7fafc;
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: #718096;
            font-size: 14px;
        }

        .metric-value {
            color: #333;
            font-weight: bold;
            font-size: 14px;
        }

        .floor-status {
            margin-top: 10px;
        }

        .floor-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin: 5px 0;
            background: #f7fafc;
            border-radius: 5px;
            font-size: 13px;
        }

        .floor-item.has-passengers {
            background: #fed7d7;
            border-left: 3px solid #f56565;
        }

        .waiting-count {
            display: flex;
            gap: 10px;
        }

        .waiting-up, .waiting-down {
            display: flex;
            align-items: center;
            gap: 3px;
            font-size: 12px;
        }

        .waiting-up {
            color: #48bb78;
        }

        .waiting-down {
            color: #ed8936;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1000;
        }

        .connection-status.connected {
            background: #c6f6d5;
            color: #22543d;
        }

        .connection-status.disconnected {
            background: #fed7d7;
            color: #742a2a;
        }

        .error-message {
            background: #fed7d7;
            color: #742a2a;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .elevator-grid {
                flex-wrap: wrap;
            }
        }

        .passenger-icon {
            font-size: 16px;
        }

        .config-info {
            background: #edf2f7;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 13px;
            color: #4a5568;
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: 20px;
        }

        .speed-control label {
            font-size: 14px;
            color: #666;
        }

        .speed-control select {
            padding: 5px 10px;
            border: 1px solid #cbd5e0;
            border-radius: 5px;
            background: white;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // APIÈÖçÁΩÆ
        const API_BASE_URL = 'http://127.0.0.1:8000';

        const ElevatorVisualization = () => {
            const [state, setState] = useState(null);
            const [isConnected, setIsConnected] = useState(false);
            const [isRunning, setIsRunning] = useState(false);
            const [error, setError] = useState(null);
            const [updateSpeed, setUpdateSpeed] = useState(500); // Êõ¥Êñ∞Èó¥Èöî(ÊØ´Áßí)
            const intervalRef = useRef(null);

            // Ëé∑ÂèñÁîµÊ¢ØÁä∂ÊÄÅ
            const fetchState = async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/state`);
                    if (!response.ok) throw new Error('Êó†Ê≥ïËé∑ÂèñÁä∂ÊÄÅ');
                    const data = await response.json();
                    setState(data);
                    setIsConnected(true);
                    setError(null);
                } catch (err) {
                    setIsConnected(false);
                    setError(err.message);
                }
            };

            // ÊâßË°å‰∏ÄÊ≠•Ê®°Êãü
            const stepSimulation = async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/step`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ticks: 1 })
                    });
                    if (!response.ok) throw new Error('Ê≠•ËøõÂ§±Ë¥•');
                    await fetchState();
                } catch (err) {
                    setError(err.message);
                }
            };

            // ÈáçÁΩÆÊ®°Êãü
            const resetSimulation = async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/reset`, {
                        method: 'POST'
                    });
                    if (!response.ok) throw new Error('ÈáçÁΩÆÂ§±Ë¥•');
                    await fetchState();
                } catch (err) {
                    setError(err.message);
                }
            };

            // ÂàáÊç¢Ëá™Âä®ËøêË°å
            const toggleAutoRun = () => {
                setIsRunning(!isRunning);
            };

            // ÂàùÂßãÂåñÂíåËá™Âä®Êõ¥Êñ∞
            useEffect(() => {
                fetchState();
            }, []);

            useEffect(() => {
                if (isRunning) {
                    intervalRef.current = setInterval(() => {
                        stepSimulation();
                    }, updateSpeed);
                } else {
                    if (intervalRef.current) {
                        clearInterval(intervalRef.current);
                    }
                }
                return () => {
                    if (intervalRef.current) {
                        clearInterval(intervalRef.current);
                    }
                };
            }, [isRunning, updateSpeed]);

            if (!state) {
                return <div className="loading">Ê≠£Âú®ËøûÊé•ÁîµÊ¢ØÊ®°ÊãüÂô®...</div>;
            }

            const { elevators, floors, passengers, metrics, tick } = state;
            const maxFloor = floors.length - 1;
            
            // ËÆ°ÁÆóÁîµÊ¢Ø‰ΩçÁΩÆÔºà‰ªéÂ∫ïÈÉ®ÂºÄÂßãÔºâ
            const getElevatorPosition = (elevator) => {
                const floorHeight = 60;
                const currentFloor = elevator.position.current_floor;
                const floorUpPosition = elevator.position.floor_up_position;
                const totalFloors = floors.length;
                
                // ‰ªéÂ∫ïÈÉ®ÂºÄÂßãËÆ°ÁÆó
                const bottomPosition = (totalFloors - 1 - currentFloor) * floorHeight;
                const offsetPosition = (floorUpPosition / 10) * floorHeight;
                
                return bottomPosition - offsetPosition + 5;
            };

            // Ëé∑ÂèñÁîµÊ¢ØÁ±ªÂêç
            const getElevatorClass = (elevator) => {
                const status = elevator.run_status;
                const direction = elevator.last_tick_direction;
                
                if (status === 'stopped') return 'elevator-car stopped';
                if (direction === 'up') return 'elevator-car moving-up';
                if (direction === 'down') return 'elevator-car moving-down';
                return 'elevator-car';
            };

            // Ëé∑ÂèñÊñπÂêëÊåáÁ§∫Âô®
            const getDirectionIndicator = (elevator) => {
                if (elevator.indicators.up) return '‚¨ÜÔ∏è';
                if (elevator.indicators.down) return '‚¨áÔ∏è';
                return '‚è∏Ô∏è';
            };

            // ÁªüËÆ°‰πòÂÆ¢‰ø°ÊÅØ
            const passengerStats = Object.values(passengers).reduce((acc, p) => {
                if (p.dropoff_tick > 0) acc.completed++;
                else if (p.pickup_tick > 0) acc.inElevator++;
                else acc.waiting++;
                return acc;
            }, { waiting: 0, inElevator: 0, completed: 0 });

            return (
                <div className="container">
                    <div className={`connection-status ${isConnected ? 'connected' : 'disconnected'}`}>
                        {isConnected ? '‚úì Â∑≤ËøûÊé•' : '‚úó Êú™ËøûÊé•'}
                    </div>

                    <div className="header">
                        <h1>üè¢ ÁîµÊ¢ØÁ≥ªÁªüÂÆûÊó∂ÁõëÊéß</h1>
                        <div className="status-bar">
                            <div style={{ display: 'flex', gap: '20px', flexWrap: 'wrap' }}>
                                <div className="status-item">
                                    <span className="status-label">ÂΩìÂâçÊó∂Âàª:</span>
                                    <span className="status-value">{tick}</span>
                                </div>
                                <div className="status-item">
                                    <span className="status-label">ÁîµÊ¢ØÊï∞Èáè:</span>
                                    <span className="status-value">{elevators.length}</span>
                                </div>
                                <div className="status-item">
                                    <span className="status-label">Ê•ºÂ±Ç:</span>
                                    <span className="status-value">{floors.length}</span>
                                </div>
                                <div className="status-item">
                                    <span className="status-label">ÊÄª‰πòÂÆ¢:</span>
                                    <span className="status-value">{Object.keys(passengers).length}</span>
                                </div>
                            </div>
                            <div className="controls">
                                <div className="speed-control">
                                    <label>ÈÄüÂ∫¶:</label>
                                    <select 
                                        value={updateSpeed} 
                                        onChange={(e) => setUpdateSpeed(Number(e.target.value))}
                                        disabled={isRunning}
                                    >
                                        <option value={100}>ÊûÅÂø´</option>
                                        <option value={250}>Âø´</option>
                                        <option value={500}>Ê≠£Â∏∏</option>
                                        <option value={1000}>ÊÖ¢</option>
                                    </select>
                                </div>
                                <button 
                                    className={`btn ${isRunning ? 'btn-danger' : 'btn-primary'}`}
                                    onClick={toggleAutoRun}
                                >
                                    {isRunning ? '‚è∏Ô∏è ÊöÇÂÅú' : '‚ñ∂Ô∏è ËøêË°å'}
                                </button>
                                <button 
                                    className="btn btn-primary"
                                    onClick={stepSimulation}
                                    disabled={isRunning}
                                >
                                    ‚è≠Ô∏è ÂçïÊ≠•
                                </button>
                                <button 
                                    className="btn btn-danger"
                                    onClick={resetSimulation}
                                >
                                    üîÑ ÈáçÁΩÆ
                                </button>
                            </div>
                        </div>
                    </div>

                    {error && (
                        <div className="error-message">
                            ‚ö†Ô∏è ÈîôËØØ: {error}
                        </div>
                    )}

                    <div className="main-content">
                        <div className="elevator-section">
                            <div className="config-info">
                                ÊØèÈÉ®ÁîµÊ¢ØÊúÄÂ§ßËΩΩÂÆ¢: {elevators[0]?.max_capacity || 0} ‰∫∫ | 
                                ÈÄüÂ∫¶: {elevators[0]?.speed_pre_tick || 0} Â±Ç/tick
                            </div>
                            <div className="elevator-grid">
                                {elevators.map((elevator) => (
                                    <div key={elevator.id} className="elevator-shaft">
                                        <div className="elevator-label">
                                            ÁîµÊ¢Ø #{elevator.id}
                                        </div>
                                        <div className="shaft-container" style={{ height: `${floors.length * 60}px` }}>
                                            {floors.map((floor, idx) => (
                                                <div key={floor.floor} className="floor-line">
                                                    <span className="floor-number">F{floors.length - 1 - idx}</span>
                                                </div>
                                            ))}
                                            <div 
                                                className={getElevatorClass(elevator)}
                                                style={{ top: `${getElevatorPosition(elevator)}px` }}
                                            >
                                                <div className="direction-indicator">
                                                    {getDirectionIndicator(elevator)}
                                                </div>
                                                <div>F{Math.floor(elevator.position.current_floor_float)}</div>
                                                <div className="elevator-passengers">
                                                    üë§ {elevator.passengers.length}/{elevator.max_capacity}
                                                </div>
                                                <div className="elevator-target">
                                                    ‚Üí F{elevator.position.target_floor}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="sidebar">
                            <div className="info-panel">
                                <div className="panel-title">üìä ÊÄßËÉΩÊåáÊ†á</div>
                                <div className="metric-row">
                                    <span className="metric-label">ÂÆåÊàê‰πòÂÆ¢</span>
                                    <span className="metric-value">
                                        {metrics.completed_passengers} / {metrics.total_passengers}
                                    </span>
                                </div>
                                <div className="metric-row">
                                    <span className="metric-label">ÂÆåÊàêÁéá</span>
                                    <span className="metric-value">
                                        {(metrics.completed_passengers / Math.max(metrics.total_passengers, 1) * 100).toFixed(1)}%
                                    </span>
                                </div>
                                <div className="metric-row">
                                    <span className="metric-label">Âπ≥ÂùáÁ≠âÂæÖÊó∂Èó¥</span>
                                    <span className="metric-value">
                                        {metrics.average_floor_wait_time.toFixed(1)} tick
                                    </span>
                                </div>
                                <div className="metric-row">
                                    <span className="metric-label">P95Á≠âÂæÖÊó∂Èó¥</span>
                                    <span className="metric-value">
                                        {metrics.p95_floor_wait_time.toFixed(1)} tick
                                    </span>
                                </div>
                                <div className="metric-row">
                                    <span className="metric-label">Âπ≥ÂùáÊóÖÁ®ãÊó∂Èó¥</span>
                                    <span className="metric-value">
                                        {metrics.average_arrival_wait_time.toFixed(1)} tick
                                    </span>
                                </div>
                            </div>

                            <div className="info-panel">
                                <div className="panel-title">üë• ‰πòÂÆ¢Áä∂ÊÄÅ</div>
                                <div className="metric-row">
                                    <span className="metric-label">Á≠âÂæÖ‰∏≠</span>
                                    <span className="metric-value">{passengerStats.waiting}</span>
                                </div>
                                <div className="metric-row">
                                    <span className="metric-label">‰πòÊ¢Ø‰∏≠</span>
                                    <span className="metric-value">{passengerStats.inElevator}</span>
                                </div>
                                <div className="metric-row">
                                    <span className="metric-label">Â∑≤ÂÆåÊàê</span>
                                    <span className="metric-value">{passengerStats.completed}</span>
                                </div>
                            </div>

                            <div className="info-panel">
                                <div className="panel-title">üèóÔ∏è Ê•ºÂ±ÇÁä∂ÊÄÅ</div>
                                <div className="floor-status">
                                    {[...floors].reverse().map((floor) => {
                                        const hasPassengers = floor.up_queue.length > 0 || floor.down_queue.length > 0;
                                        return (
                                            <div 
                                                key={floor.floor} 
                                                className={`floor-item ${hasPassengers ? 'has-passengers' : ''}`}
                                            >
                                                <span>Ê•ºÂ±Ç {floor.floor}</span>
                                                <div className="waiting-count">
                                                    {floor.up_queue.length > 0 && (
                                                        <span className="waiting-up">
                                                            ‚¨ÜÔ∏è {floor.up_queue.length}
                                                        </span>
                                                    )}
                                                    {floor.down_queue.length > 0 && (
                                                        <span className="waiting-down">
                                                            ‚¨áÔ∏è {floor.down_queue.length}
                                                        </span>
                                                    )}
                                                    {!hasPassengers && (
                                                        <span style={{ color: '#a0aec0', fontSize: '12px' }}>
                                                            Êó†‰∫∫Á≠âÂæÖ
                                                        </span>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<ElevatorVisualization />, document.getElementById('root'));
    </script>
</body>
</html>
